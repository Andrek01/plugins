{% extends "base_plugin.html" %}
{% set tabcount = 2 %}
{% if len(init_repo) > 0 %}
	{% set tabcount = 2 %}
{%  endif %}
{% set dataSet = 'overview' %}
{% set tab1title = _('Plugins in GitHub-Repos') %}
{% set tab2title = _('Zur Installation vorbereitet') %}

{% block pluginstyles %}
<link rel="stylesheet" href="static/style.css">
{% endblock pluginstyles %}

{% block buttons %}
<button id='install' class="btn btn-shng btn-sm" onclick='javascript:document.getElementById("installModal").style.display = "block";' type="button">Neues Plugin installieren</button>
<button id='rescan' class="btn btn-shng btn-sm" onclick='location.href="?action=rescan"' type="button">Plugin-Verzeichnis neu lesen</button>
{% endblock buttons %}

{% block headtable %}
<div id="pluginModal" class="or-modal">
	<div class="or-modal-content">
		<span class="or-close" onclick="document.getElementById('pluginModal').style.display = 'none';">&times;</span>
		<div>
			<strong>Installieren von Plugin <span id='doplugin'></span> aus dem Repo <span id='doowner'></span>/plugins, Branch <span id='dobranch'></span></strong>
		</div>
		<div>
			<span id="modalButtons" display="block">
				<span>Soll das Plugin wirklich installiert werden?</span><br />
				<button type="button" id="btn-plugin-inst" class="btn btn-danger btn-sm" onclick="installPlugin(this)">Installieren</button>
				<button type="button" class="btn btn-shng btn-sm" onclick="document.getElementById('pluginModal').style.display = 'none';">Abbrechen</button>
			</span>
			<span id="modalSpinner" display="none">Installation wird ausgeführt. Bitte Geduld, dies kann etwas dauern... </span>
		</div>
	</div>		
</div>

<div id="pluginModal2" class="or-modal">
	<div class="or-modal-content">
		<span class="or-close" onclick="document.getElementById('pluginModal2').style.display = 'none';">&times;</span>
		<div>
			<strong>Entfernen von Plugin <span id='doplugin2'></span> aus dem Repo <span id='doowner2'></span>/plugins, Branch <span id='dobranch2'></span></strong>
			<span id='doname2' style='display: none;'></span>
		</div>
		<div>
			<span id="modalButtons2" display="block">
				<span>Soll das Plugin wirklich gelöscht werden?</span><br />
				<button type="button" id="btn-plugin-inst2" class="btn btn-danger btn-sm" onclick="removePlugin(this)">Löschen</button>
				<button type="button" class="btn btn-shng btn-sm" onclick="document.getElementById('pluginModal2').style.display = 'none';">Abbrechen</button>
			</span>
			<span id="modalSpinner2" display="none">Löschen wird ausgeführt. Bitte Geduld, dies kann etwas dauern... </span>
		</div>
	</div>		
</div>

<div id="installModal" class="in-modal">
	<div class="or-modal-content">
		<span class="or-close" onclick="document.getElementById('installModal').style.display = 'none';">&times;</span>
		<div>
			<strong>Neues Plugin installieren</strong>
		</div>
		<div>
			<form id='install'>
				<div class="container-fluid m-2">
					<div class="mb-2">Plugin installieren aus:</div>
					<table>
						<tr>
							<td>PR:</td>
							<td colspan=3>
								<select id='pr' {% if len(pulls) == 0 %}disabled {% endif %} onchange="javascript:selectedPR(this);">
									<option value=''>(PR auswählen)</option>
									{% for pr in pulls %}
									<option value='{{ pr }}'>{{ pr }}: {{ pulls[pr].title }}</option>
									{% endfor %}
								</select>
							</td>
							<td>&nbsp;</td>
						</tr>
						<tr>
							<td>Repo von:</td>
							<td>
								<select id='owner' onchange="javascript:updateBranches(this);">
									<option value=''>(Repo auswählen)</option>
									{% for owner in forklist %}
									<option>{{ owner }}</option>
									{% endfor %}
								</select>
							</td>
							<td style='padding-left: 15px;'>Branch:</td>
							<td>
								<select id='branch' disabled onchange="javascript:selectedBranch(this);">
								<option value=''>(Branch auswählen)</option>
								</select>
							</td>
							<td style='padding-left: 15px;'>
								<button id='btn-branch' disabled type="button" class="btn btn-shng btn-sm" onclick="javascript:updatePlugins(this);">Auswählen</button>
							</td>
						</tr>
						<tr>
							<td>Plugin:</td>
							<td>
								<select id='plugin' disabled onchange="javascript:selectedPlugin(this);">
									<option value=''>(Plugin auswählen)</option>
								</select>
							</td>
							<td style='padding-left: 15px;'>Name:</td>
							<td><input id='name' disabled /></td>
							<td style='padding-left: 15px;'>
								<button id='btn-plugin' disabled type="button" class="btn btn-shng btn-sm" onclick="javascript:selectPlugin(this);">Auswählen</button>					
							</td>
						</tr>
					</table>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock headtable %}

{% block pluginscripts %}
<link rel="stylesheet" type="text/css" href="static/datatables_min.css">
<script type="text/javascript" charset="utf8" src="static/datatables_min.js"></script>

<script type="text/javascript">
	$(document).ready( function () {
	    $('#plugintable').DataTable( {
	        "paging": false,
	        fixedHeader: true
	        } );
	    $('#inittable').DataTable( {
	        "paging": false,
	        fixedHeader: true
	        } );
	});

	var pulls = {{ pulls }};

	function clearSelect(sel) {
		var i, L = sel.options.length - 1;
		for (i = L; i > 0; i--) {
			sel.remove(i);
		}		
	}

	function addOption(sel, val, def) {
		var option = document.createElement('option');
		option.text = val;
		if (def) {
			option.selected = true;
		}
		sel.add(option);
	}

	function showModal(owner, branch, plugin, nr, name) {
		document.getElementById('doplugin' + nr).textContent = plugin;
		document.getElementById('doowner' + nr).textContent = owner;
		document.getElementById('dobranch' + nr).textContent = branch;
		document.getElementById('modalButtons' + nr).style.display = 'block';
		document.getElementById('modalSpinner' + nr).style.display = 'none';
		document.getElementById('pluginModal' + nr).style.display = 'block';
		if (nr == '2') {
			document.getElementById('doname2').textContent = name;
		}
	}

	function hideModal(nr) {
		document.getElementById('pluginModal' + nr).style.display = 'none';
		document.getElementById('doplugin' + nr).textContent = '';
		document.getElementById('doowner' + nr).textContent = '';
		document.getElementById('dobranch' + nr).textContent = '';
		document.getElementById('modalButtons' + nr).style.display = 'block';
		document.getElementById('modalSpinner' + nr).style.display = 'none';
		if (nr == 2) {
			document.getElementById('doname2').textContent = '';
		}
	}

	function spinModal(nr) {
		document.getElementById('modalButtons' + nr).style.display = 'none';
		document.getElementById('modalSpinner' + nr).style.display = 'block';		
	}

	function selectedPR(selObj) {
		var PR = document.getElementById('pr').value;
		if (PR > 0) {
			document.getElementById('owner').value = pulls[PR]['owner'];
			var branch = document.getElementById('branch');
			clearSelect(branch);
			addOption(branch, pulls[PR]['branch']);
			branch.value = pulls[PR]['branch'];
			document.getElementById('branch').disabled = false;
			document.getElementById('btn-branch').disabled = false;
			document.getElementById('btn-plugin').disabled = true;
			clearPlugin();
		}
	}

	function clearPlugin() {
		var p = document.getElementById('plugin');
		clearSelect(p);
		p.disabled = true;

		var n = document.getElementById('name');
		n.value = '';
		n.disabled = true;		
	}

	function updateBranches(selObj) {
		var owner = document.getElementById('owner').value;
		clearPlugin();

		if (owner != '') {
			$.ajax({
				type: "POST",
				url: "updateBranches",
				data: JSON.stringify({'owner': owner}),
				contentType: 'application/json',
				dataType: 'json',
				error: function(response) {
					alert("Fehler beim Übermitteln der Daten. Bitte shng-Log prüfen!");
				},
				success: function(response) {
					var item = document.getElementById('branch');

					// enable branch options
					item.disabled = false;

					// clear options
					clearSelect(item);

					// add all branches except master and main
					for (const branch of response['data']) {
						if (branch == 'master' || branch == 'main') {
							continue;
						}
						addOption(item, branch, false);
					}
				}
			})
		}
	}

	function selectedBranch(selObj) {
		if (document.getElementById('branch').value != '') {
			document.getElementById('btn-branch').disabled = false;
		} else {
			document.getElementById('btn-branch').disabled = true;
			document.getElementById('btn-plugin').disabled = true;
		}
	}

	function updatePlugins(selObj) {
		var owner = document.getElementById('owner').value;
		var branch = document.getElementById('branch').value;

		document.getElementById('pr').value = '';

		if (owner != '' && branch != '') {
			$.ajax({
				type: "POST",
				url: "updatePlugins",
				data: JSON.stringify({'owner': owner, 'branch': branch}),
				contentType: 'application/json',
				dataType: 'json',
				error: function(response) {
					alert("Fehler beim Übermitteln der Daten. Bitte shng-Log prüfen!");
				},
				success: function(response) {
					var item = document.getElementById('plugin');

					// enable branch options
					item.disabled = false;

					// clear options
					clearSelect(item);

					// add all branches except master and main
					for (const plugin of response['data']) {
						addOption(item, plugin, plugin==branch);
					}
					selectedPlugin(this);

					document.getElementById('btn-plugin').disabled = false;
				}
			})
		}
	}

	function selectedPlugin(selObj) {
		var owner = document.getElementById('owner').value;
		var branch = document.getElementById('branch').value;
		var plugin = document.getElementById('plugin').value;

		var name = owner + "/" + branch + "-" + plugin;

		document.getElementById('name').value = name;
		document.getElementById('name').disabled = false;
	}

	function selectPlugin(selObj) {
		var owner = document.getElementById('owner').value;
		var branch = document.getElementById('branch').value;
		var plugin = document.getElementById('plugin').value;
		var name = document.getElementById('name').value;

		if (owner != '' && branch != '' && plugin != '') {
			$.ajax({
				type: "POST",
				url: "selectPlugin",
				data: JSON.stringify({'owner': owner, 'branch': branch, 'plugin': plugin, 'name': name, 'confirm': false}),
				contentType: 'application/json',
				dataType: 'json',
				error: function(response) {
					alert("Fehler beim Initialisieren: " + response['data'])
				},
				success: function(response) {
					showModal(owner, branch, plugin, '');
				}
			})
		}
	}

	function installPlugin(selObj) {
		var owner = document.getElementById('owner').value;
		var branch = document.getElementById('branch').value;
		var plugin = document.getElementById('plugin').value;
		var name = document.getElementById('name').value;
		doInstallPlugin(owner, branch, plugin, name);
	}

	function doInstallPlugin(owner, branch, plugin, name) {
		showModal(owner, branch, plugin, '');
		if (owner != '' && branch != '' && plugin != '') {
			spinModal('');
			$.ajax({
				type: "POST",
				url: "selectPlugin",
				data: JSON.stringify({'owner': owner, 'branch': branch, 'plugin': plugin, 'name': name, 'confirm': true}),
				contentType: 'application/json',
				dataType: 'json',
				error: function(response) {
					alert("Fehler beim Installieren: " + response['data'])
				},
				success: function(response) {
					hideModal('');
					setTimeout(window.location.reload(), 300); 
				}
			})
		}
	}

	function removePlugin(selObj) {
		var name = document.getElementById('doname2').textContent;
		if (name != '') {
			spinModal('2');
			$.ajax({
				type: "POST",
				url: "removePlugin",
				data: JSON.stringify({'name': name}),
				contentType: 'application/json',
				dataType: 'json',
				error: function(response) {
					alert("Fehler beim Entfernen: " + response['data'])
				},
				success: function(response) {
					hideModal('2');
					// setTimeout(window.location.reload(), 300); 
				}
			})
		}
	}


</script>

{% endblock pluginscripts %}


{% block bodytab1 %}

<div class="container-fluid m-2 table-responsive">
	<div>Die folgenden Plugins sind von extern installiert:</div>
	<table id="plugintable">
		<thead>
		<tr><th></th>
			<th>Name</th>
			<th>Plugin</th>
			<th>Autor</th>
			<th>Branch</th>
			<th>Pfad (Worktree)</th>
			<th>Aktion</th>
		</tr>
		</thead>
		<tbody>
		{% for plugin in repos %}
			<tr>
				<td></td>
				<td id="{{ plugin }}_name">{{ plugin }}</td>
				<td id="{{ plugin }}_plugin">{{ repos[plugin].plugin }}</td>
				<td id="{{ plugin }}_owner">{{ repos[plugin].owner }}</td>
				<td id="{{ plugin }}_branch">{{ repos[plugin].branch }}</td>
				<td id="{{ plugin }}_wtpath">{{ repos[plugin].full_wt_path }}</td>
				<td id="{{ plugin }}_action">{% if repos[plugin].dirty %}Änderungen vorhanden{% else %}<button type="button" class="btn btn-danger btn-sm" onclick="javascript:showModal('{{ repos[plugin].owner }}', '{{ repos[plugin].branch }}', '{{ repos[plugin].plugin }}', '2', '{{ plugin }}');"><i class="fas fa-times"></i></button>{% endif %}</td>
				</tr>
		{% endfor %}
		</tbody>
	</table>
</div>

{% endblock bodytab1 %}

{% if init_repos|length > 0 %}

{% block bodytab2 %}
<div class="container-fluid m-2 table-responsive">
	<div>Die folgenden Plugins sind zur Installation vorbereitet, aber noch nicht installiert:</div>
	<table id="inittable">
		<thead>
		<tr><th></th>
			<th>Name</th>
			<th>Plugin</th>
			<th>Autor</th>
			<th>Branch</th>
			<th>Pfad (Worktree)</th>
			<th></th>
		</tr>
		</thead>
		<tbody>
		{% for plugin in init_repos %}
			<tr>
				<td></td>
				<td id="{{ plugin }}_name">{{ plugin }}</td>
				<td id="{{ plugin }}_plugin">{{ init_repos[plugin].plugin }}</td>
				<td id="{{ plugin }}_owner">{{ init_repos[plugin].owner }}</td>
				<td id="{{ plugin }}_branch">{{ init_repos[plugin].branch }}</td>
				<td id="{{ plugin }}_wtpath">{{ init_repos[plugin].full_wt_path }}</td>
				<td><button type="button" class="btn btn-shng btn-sm" onclick="javascript:doInstallPlugin('{{ init_repos[plugin].owner }}', '{{ init_repos[plugin].branch }}', '{{ init_repos[plugin].plugin }}', '{{ plugin }}');"><i class="fas fa-share"></i></button>
				</td>
				</tr>
		{% endfor %}
		</tbody>
	</table>
</div>
<hr />
{% endblock bodytab2 %}

{% endif %}

